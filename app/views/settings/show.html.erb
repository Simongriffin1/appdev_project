<div class="card">
  <h1 class="page-title">Settings</h1>
  <p class="muted">Configure when and how often you receive journaling prompts via email.</p>

  <% if @user.errors.any? %>
    <div class="flash flash--alert">
      <% @user.errors.full_messages.each do |msg| %>
        <div><%= msg %></div>
      <% end %>
    </div>
  <% end %>

  <%= form_with model: @user, url: settings_path, method: :patch do |f| %>
    <div class="form-field">
      <%= f.label :time_zone, "Time Zone" %>
      <%= f.time_zone_select :time_zone, ActiveSupport::TimeZone.all, { default: "America/Chicago", selected: @user.time_zone || "America/Chicago" }, { required: true } %>
      <small class="muted">All times will be in your local time zone.</small>
    </div>

    <div class="form-field">
      <%= f.label :schedule_frequency, "Email Frequency" %>
      <% current_frequency = @user.schedule_frequency || @user.prompt_frequency %>
      <%= f.select :schedule_frequency, 
          options_for_select([
            ["Daily", "daily"],
            ["Weekdays only", "weekdays"],
            ["Weekly", "weekly"]
          ], current_frequency),
          { prompt: "Select frequency", include_blank: false },
          { required: true } %>
      <small class="muted">How often you want to receive journaling prompts.</small>
    </div>

    <div class="form-field">
      <%= f.label :schedule_time, "Send Time (local time)" %>
      <% 
        # Support both schedule_time (Time) and send_times (string)
        time_value = if @user.schedule_time.present?
                      @user.schedule_time.strftime("%H:%M")
                    elsif @user.send_times.present?
                      @user.send_times.split(",").first&.strip
                    else
                      "09:00"
                    end
      %>
      <%= f.time_field :schedule_time, 
          value: time_value,
          required: true %>
      <small class="muted">Time in 24-hour format (e.g., 09:00 for 9am). You can set multiple times by editing send_times directly if needed.</small>
    </div>

    <div class="btn-row" style="margin-top: 1.5rem;">
      <%= f.submit "Save Settings", class: "btn btn-primary" %>
      <% if current_user.onboarding_complete? %>
        <%= link_to "Cancel", dashboard_path, class: "btn btn-ghost" %>
      <% end %>
    </div>
  <% end %>
</div>
